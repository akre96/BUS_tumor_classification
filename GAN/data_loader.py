#data_loader.py
import cv2 as cv 
from numpy import clip
import fnmatch
import os
import numpy as np

"""Separate the images into 2 bins, img and corresponding masks"""
def separate(lst, key="*_mask.png"):
    no_match = []
    match = []
    
    for i in lst:
        if fnmatch.fnmatch(i, key):
            match.append(i)
        else:
            no_match.append(i)
    return match, no_match

"""Preprocess intensity scales"""
def preprocessing(img, out_size):
    img = cv.resize(img, dsize=out_size, interpolation=cv.INTER_NEAREST)
    img = (img - img.min()) / (img.max() - img.min())
    img = (img - img.mean()) / img.std()
    img  = clip(img, -1.0, 1.0)
    img = (img + 1.0) / 2.0
    #img = img.astype(np.float32) / 255
    return img.astype(np.float32)

"""remnant code to see whether white texts could be remove""" 
def removeTexts(img):
    mask = cv.threshold(img, 210, 255, cv.THRESH_BINARY)[1][:,:,0]
    dst = cv.inpaint(img, mask, 7, cv.INPAINT_NS)
    return img 

"""read all images and store them"""
def readAll(imgDir, imgs, process= True, out_size = (256,256)):
    readIMGS = []
    for i in imgs:
        path = os.path.join(imgDir, i)
        if(os.path.exists(path)):
            img= cv.imread(path, cv.IMREAD_GRAYSCALE)
            if process:
                img = preprocessing(img, out_size)
            readIMGS.append(img)
        else:
            print("file error, ", os.path.join(imgDir, i))
    return readIMGS

def getgoodfiles():
    goodfiles=[ 'benign (10).png', 
                'benign (100).png', 
                'benign (101).png', 
                'benign (103).png', 
                'benign (104).png', 
                'benign (105).png', 
                'benign (106).png', 
                'benign (107).png', 
                'benign (108).png', 
                'benign (109).png', 
                'benign (110).png', 
                'benign (111).png', 
                'benign (112).png', 
                'benign (113).png', 
                'benign (114).png', 
                'benign (116).png', 
                'benign (117).png', 
                'benign (118).png', 
                'benign (119).png', 
                'benign (12).png', 
                'benign (120).png', 
                'benign (121).png', 
                'benign (122).png', 
                'benign (124).png', 
                'benign (125).png', 
                'benign (126).png', 
                'benign (127).png', 
                'benign (128).png', 
                'benign (129).png', 
                'benign (130).png', 
                'benign (131).png', 
                'benign (132).png', 
                'benign (133).png', 
                'benign (134).png', 
                'benign (135).png', 
                'benign (136).png', 
                'benign (137).png', 
                'benign (138).png', 
                'benign (139).png', 
                'benign (140).png', 
                'benign (142).png', 
                'benign (143).png', 
                'benign (144).png', 
                'benign (145).png', 
                'benign (146).png', 
                'benign (147).png', 
                'benign (148).png', 
                'benign (149).png', 
                'benign (15).png', 
                'benign (150).png', 
                'benign (151).png', 
                'benign (152).png', 
                'benign (153).png', 
                'benign (154).png', 
                'benign (155).png', 
                'benign (156).png', 
                'benign (157).png', 
                'benign (158).png', 
                'benign (159).png', 
                'benign (16).png', 
                'benign (160).png', 
                'benign (161).png', 
                'benign (162).png', 
                'benign (163).png', 
                'benign (164).png', 
                'benign (165).png', 
                'benign (166).png', 
                'benign (167).png', 
                'benign (168).png', 
                'benign (169).png', 
                'benign (17).png', 
                'benign (170).png', 
                'benign (171).png', 
                'benign (172).png', 
                'benign (173).png', 
                'benign (174).png', 
                'benign (175).png', 
                'benign (176).png', 
                'benign (177).png', 
                'benign (178).png', 
                'benign (179).png', 
                'benign (18).png', 
                'benign (180).png', 
                'benign (181).png', 
                'benign (182).png', 
                'benign (183).png', 
                'benign (184).png', 
                'benign (185).png', 
                'benign (186).png', 
                'benign (187).png', 
                'benign (188).png', 
                'benign (189).png', 
                'benign (190).png', 
                'benign (191).png', 
                'benign (192).png', 
                'benign (193).png', 
                'benign (194).png', 
                'benign (195).png', 
                'benign (196).png', 
                'benign (197).png', 
                'benign (198).png', 
                'benign (20).png', 
                'benign (21).png', 
                'benign (219).png', 
                'benign (22).png', 
                'benign (23).png', 
                'benign (233).png', 
                'benign (24).png', 
                'benign (25).png', 
                'benign (26).png', 
                'benign (269).png', 
                'benign (27).png', 
                'benign (272).png', 
                'benign (28).png', 
                'benign (283).png', 
                'benign (29).png', 
                'benign (299).png', 
                'benign (30).png', 
                'benign (307).png', 
                'benign (308).png', 
                'benign (31).png', 
                'benign (310).png', 
                'benign (311).png', 
                'benign (312).png', 
                'benign (313).png', 
                'benign (314).png', 
                'benign (315).png', 
                'benign (316).png', 
                'benign (317).png', 
                'benign (32).png', 
                'benign (324).png', 
                'benign (325).png', 
                'benign (327).png', 
                'benign (328).png', 
                'benign (329).png', 
                'benign (33).png', 
                'benign (332).png', 
                'benign (333).png', 
                'benign (335).png', 
                'benign (336).png', 
                'benign (337).png', 
                'benign (338).png', 
                'benign (339).png', 
                'benign (34).png', 
                'benign (340).png', 
                'benign (341).png', 
                'benign (342).png', 
                'benign (344).png', 
                'benign (345).png', 
                'benign (346).png', 
                'benign (347).png', 
                'benign (348).png', 
                'benign (349).png', 
                'benign (35).png', 
                'benign (350).png', 
                'benign (351).png', 
                'benign (352).png', 
                'benign (353).png', 
                'benign (354).png', 
                'benign (355).png', 
                'benign (356).png', 
                'benign (357).png', 
                'benign (358).png', 
                'benign (359).png', 
                'benign (36).png', 
                'benign (360).png', 
                'benign (361).png', 
                'benign (363).png', 
                'benign (364).png', 
                'benign (365).png', 
                'benign (368).png', 
                'benign (369).png', 
                'benign (37).png', 
                'benign (370).png', 
                'benign (371).png', 
                'benign (372).png', 
                'benign (373).png', 
                'benign (374).png', 
                'benign (375).png', 
                'benign (376).png', 
                'benign (377).png', 
                'benign (378).png', 
                'benign (379).png', 
                'benign (38).png', 
                'benign (380).png', 
                'benign (381).png', 
                'benign (382).png', 
                'benign (383).png', 
                'benign (384).png', 
                'benign (385).png', 
                'benign (386).png', 
                'benign (387).png', 
                'benign (388).png', 
                'benign (389).png', 
                'benign (39).png', 
                'benign (391).png', 
                'benign (392).png', 
                'benign (393).png', 
                'benign (394).png', 
                'benign (395).png', 
                'benign (396).png', 
                'benign (398).png', 
                'benign (399).png', 
                'benign (40).png', 
                'benign (400).png', 
                'benign (402).png', 
                'benign (403).png', 
                'benign (404).png', 
                'benign (405).png', 
                'benign (406).png', 
                'benign (408).png', 
                'benign (41).png', 
                'benign (411).png', 
                'benign (412).png', 
                'benign (413).png', 
                'benign (414).png', 
                'benign (415).png', 
                'benign (417).png', 
                'benign (418).png', 
                'benign (419).png', 
                'benign (42).png', 
                'benign (420).png', 
                'benign (421).png', 
                'benign (423).png', 
                'benign (424).png', 
                'benign (425).png', 
                'benign (429).png', 
                'benign (43).png', 
                'benign (430).png', 
                'benign (431).png', 
                'benign (434).png', 
                'benign (435).png', 
                'benign (437).png', 
                'benign (44).png', 
                'benign (45).png', 
                'benign (46).png', 
                'benign (47).png', 
                'benign (48).png', 
                'benign (49).png', 
                'benign (50).png', 
                'benign (51).png', 
                'benign (53).png', 
                'benign (54).png', 
                'benign (55).png', 
                'benign (56).png', 
                'benign (57).png', 
                'benign (58).png', 
                'benign (59).png', 
                'benign (60).png', 
                'benign (61).png', 
                'benign (62).png', 
                'benign (63).png', 
                'benign (65).png', 
                'benign (66).png', 
                'benign (67).png', 
                'benign (68).png', 
                'benign (69).png', 
                'benign (7).png', 
                'benign (70).png', 
                'benign (71).png', 
                'benign (72).png', 
                'benign (73).png', 
                'benign (74).png', 
                'benign (75).png', 
                'benign (76).png', 
                'benign (77).png', 
                'benign (78).png', 
                'benign (8).png', 
                'benign (80).png', 
                'benign (81).png', 
                'benign (82).png', 
                'benign (83).png', 
                'benign (84).png', 
                'benign (85).png', 
                'benign (86).png', 
                'benign (87).png', 
                'benign (88).png', 
                'benign (89).png', 
                'benign (90).png', 
                'benign (91).png', 
                'benign (92).png', 
                'benign (93).png', 
                'benign (94).png', 
                'benign (95).png', 
                'benign (96).png', 
                'benign (98).png', 
                'benign (99).png', 
                'malignant (1).png', 
                'malignant (100).png', 
                'malignant (101).png', 
                'malignant (102).png', 
                'malignant (103).png', 
                'malignant (104).png', 
                'malignant (105).png', 
                'malignant (106).png', 
                'malignant (107).png', 
                'malignant (108).png', 
                'malignant (109).png', 
                'malignant (115).png', 
                'malignant (116).png', 
                'malignant (117).png', 
                'malignant (118).png', 
                'malignant (120).png', 
                'malignant (133).png', 
                'malignant (134).png', 
                'malignant (135).png', 
                'malignant (136).png', 
                'malignant (137).png', 
                'malignant (138).png', 
                'malignant (141).png', 
                'malignant (142).png', 
                'malignant (144).png', 
                'malignant (146).png', 
                'malignant (147).png', 
                'malignant (149).png', 
                'malignant (150).png', 
                'malignant (151).png', 
                'malignant (152).png', 
                'malignant (154).png', 
                'malignant (155).png', 
                'malignant (156).png', 
                'malignant (158).png', 
                'malignant (159).png', 
                'malignant (16).png', 
                'malignant (160).png', 
                'malignant (161).png', 
                'malignant (162).png', 
                'malignant (163).png', 
                'malignant (164).png', 
                'malignant (165).png', 
                'malignant (166).png', 
                'malignant (168).png', 
                'malignant (17).png', 
                'malignant (170).png', 
                'malignant (171).png', 
                'malignant (172).png', 
                'malignant (173).png', 
                'malignant (174).png', 
                'malignant (175).png', 
                'malignant (176).png', 
                'malignant (177).png', 
                'malignant (178).png', 
                'malignant (179).png', 
                'malignant (18).png', 
                'malignant (181).png', 
                'malignant (183).png', 
                'malignant (184).png', 
                'malignant (185).png', 
                'malignant (186).png', 
                'malignant (187).png', 
                'malignant (188).png', 
                'malignant (189).png', 
                'malignant (19).png', 
                'malignant (190).png', 
                'malignant (191).png', 
                'malignant (192).png', 
                'malignant (193).png', 
                'malignant (194).png', 
                'malignant (195).png', 
                'malignant (197).png', 
                'malignant (198).png', 
                'malignant (199).png', 
                'malignant (20).png', 
                'malignant (200).png', 
                'malignant (201).png', 
                'malignant (202).png', 
                'malignant (203).png', 
                'malignant (204).png', 
                'malignant (205).png', 
                'malignant (206).png', 
                'malignant (209).png', 
                'malignant (21).png', 
                'malignant (210).png', 
                'malignant (22).png', 
                'malignant (23).png', 
                'malignant (24).png', 
                'malignant (25).png', 
                'malignant (26).png', 
                'malignant (27).png', 
                'malignant (28).png', 
                'malignant (29).png', 
                'malignant (3).png', 
                'malignant (30).png', 
                'malignant (31).png', 
                'malignant (32).png', 
                'malignant (33).png', 
                'malignant (34).png', 
                'malignant (35).png', 
                'malignant (36).png', 
                'malignant (37).png', 
                'malignant (38).png', 
                'malignant (39).png', 
                'malignant (4).png', 
                'malignant (40).png', 
                'malignant (41).png', 
                'malignant (42).png', 
                'malignant (43).png', 
                'malignant (44).png', 
                'malignant (45).png', 
                'malignant (46).png', 
                'malignant (47).png', 
                'malignant (48).png', 
                'malignant (49).png', 
                'malignant (5).png', 
                'malignant (50).png', 
                'malignant (51).png', 
                'malignant (52).png', 
                'malignant (54).png', 
                'malignant (55).png', 
                'malignant (56).png', 
                'malignant (57).png', 
                'malignant (58).png', 
                'malignant (59).png', 
                'malignant (6).png', 
                'malignant (60).png', 
                'malignant (62).png', 
                'malignant (63).png', 
                'malignant (64).png', 
                'malignant (65).png', 
                'malignant (66).png', 
                'malignant (67).png', 
                'malignant (68).png', 
                'malignant (69).png', 
                'malignant (7).png', 
                'malignant (70).png', 
                'malignant (71).png', 
                'malignant (72).png', 
                'malignant (73).png', 
                'malignant (74).png', 
                'malignant (75).png', 
                'malignant (76).png', 
                'malignant (77).png', 
                'malignant (78).png', 
                'malignant (79).png', 
                'malignant (8).png', 
                'malignant (80).png', 
                'malignant (82).png', 
                'malignant (84).png', 
                'malignant (85).png', 
                'malignant (86).png', 
                'malignant (87).png', 
                'malignant (88).png', 
                'malignant (89).png', 
                'malignant (9).png', 
                'malignant (90).png', 
                'malignant (91).png', 
                'malignant (92).png', 
                'malignant (93).png', 
                'malignant (94).png', 
                'malignant (95).png', 
                'malignant (96).png', 
                'malignant (97).png', 
                'malignant (98).png', 
                'malignant (99).png', 
                'normal (1).png', 
                'normal (10).png', 
                'normal (100).png', 
                'normal (101).png', 
                'normal (102).png', 
                'normal (103).png', 
                'normal (104).png', 
                'normal (105).png', 
                'normal (106).png', 
                'normal (107).png', 
                'normal (108).png', 
                'normal (109).png', 
                'normal (11).png', 
                'normal (110).png', 
                'normal (111).png', 
                'normal (112).png', 
                'normal (115).png', 
                'normal (116).png', 
                'normal (117).png', 
                'normal (119).png', 
                'normal (12).png', 
                'normal (120).png', 
                'normal (123).png', 
                'normal (124).png', 
                'normal (125).png', 
                'normal (126).png', 
                'normal (127).png', 
                'normal (128).png', 
                'normal (129).png', 
                'normal (13).png', 
                'normal (130).png', 
                'normal (131).png', 
                'normal (132).png', 
                'normal (133).png', 
                'normal (14).png', 
                'normal (15).png', 
                'normal (16).png', 
                'normal (17).png', 
                'normal (18).png', 
                'normal (19).png', 
                'normal (2).png', 
                'normal (20).png', 
                'normal (21).png', 
                'normal (22).png', 
                'normal (23).png', 
                'normal (24).png', 
                'normal (25).png', 
                'normal (26).png', 
                'normal (27).png', 
                'normal (28).png', 
                'normal (29).png', 
                'normal (3).png', 
                'normal (30).png', 
                'normal (32).png', 
                'normal (33).png', 
                'normal (34).png', 
                'normal (35).png', 
                'normal (36).png', 
                'normal (37).png', 
                'normal (38).png', 
                'normal (39).png', 
                'normal (4).png', 
                'normal (40).png', 
                'normal (41).png', 
                'normal (42).png', 
                'normal (43).png', 
                'normal (44).png', 
                'normal (45).png', 
                'normal (46).png', 
                'normal (47).png', 
                'normal (48).png', 
                'normal (49).png', 
                'normal (5).png', 
                'normal (50).png', 
                'normal (51).png', 
                'normal (52).png', 
                'normal (53).png', 
                'normal (54).png', 
                'normal (55).png', 
                'normal (56).png', 
                'normal (57).png', 
                'normal (58).png', 
                'normal (59).png', 
                'normal (6).png', 
                'normal (60).png', 
                'normal (61).png', 
                'normal (62).png', 
                'normal (63).png', 
                'normal (64).png', 
                'normal (65).png', 
                'normal (66).png', 
                'normal (67).png', 
                'normal (68).png', 
                'normal (69).png', 
                'normal (7).png', 
                'normal (70).png', 
                'normal (71).png', 
                'normal (72).png', 
                'normal (73).png', 
                'normal (74).png', 
                'normal (75).png', 
                'normal (76).png', 
                'normal (78).png', 
                'normal (79).png', 
                'normal (8).png', 
                'normal (80).png', 
                'normal (81).png', 
                'normal (82).png', 
                'normal (83).png', 
                'normal (84).png', 
                'normal (85).png', 
                'normal (86).png', 
                'normal (87).png', 
                'normal (88).png', 
                'normal (89).png', 
                'normal (9).png', 
                'normal (90).png', 
                'normal (91).png', 
                'normal (92).png', 
                'normal (93).png', 
                'normal (94).png', 
                'normal (95).png', 
                'normal (96).png', 
                'normal (97).png', 
                'normal (98).png',
                'normal (99).png']
    return goodfiles

def get_stratified_good_files():
    goodfiles = getgoodfiles()
    benign, nomatch = separate(lst = goodfiles, key = "benign (*).png")
    malignant, nomatch = separate(lst = goodfiles, key = "malignant (*).png")
    normal, nomatch = separate(lst = goodfiles, key = "normal (*).png")
    return normal, benign, malignant

__all__ = [separate, preprocessing, removeTexts, readAll, getgoodfiles, get_stratified_good_files]

